---
title: "Betting Strategy and Model Validation (Testing)"
author: "[Ryo®, Eng Lian Hu](http://englianhu.wordpress.com) <img src='figure/ShirotoNorimichi.jpg' width='24'> 白戸則道®"
date: "7/22/2015"
output:
  html_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 5
    highlight: haddock
    theme: cerulean
    toc: yes
  word_document: 
    fig_caption: yes
  pdf_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 5
    highlight: haddock
    toc: yes
---



<img src='figure/JJ 02.jpg' width='168'>

  [Scibrokes®](http://www.scibrokes.com)   [TonyStark®](https://about.me/englianhu)



## Abstract

  This is an academic research by apply R statistics analysis to an agency A of an existing betting consultancy firm A. According to the [Dixon and Pope (2003)](http://www.sciencedirect.com/science/article/pii/S016920700400010X), due to business confidential and privacy I am also using agency A and firm A in this paper. **The purpose of the anaysis is measure the staking model of the firm A**. For more sample which using R for Soccer Betting see <http://rpubs.com/englianhu>. Here is the references of [rmarkdown](http://rmarkdown.rstudio.com/authoring_basics.html) and [An Introduction to R Markdown](http://rpubs.com/mansun_kuo/24330). You are welcome to read the [Wrangling F1 Data With R](http://www.r-bloggers.com/wrangling-f1-data-with-r-f1datajunkie-book/) if you are getting interest to write a data analysis on Sports-book.

```{r libs, message=FALSE, warning=FALSE, include=FALSE}
## Loading the packages and setting adjustment
suppressMessages(source(paste0(getwd(),'/function/libs.R')))
```



## 1. Introduction to the Betting Stategics

  There are quite some betting strategies in sport-book industry. [Value betting](http://www.valuepunter.com/valuebetting.htm) is the popular staking strategy. Money management is the key for betting strategy.

  The best and the most successful punters are money managers looking for ideal situations, which are defined as matches with only high percentage of return. In individual situations luck will play into the outcome of an event, which no amount of odds compiling can overcome, but in the long run a disciplined punter will win more of those lucky games than lose.



## 2. Dataset


### 2.1 Collect and Reprocess the Dataset

  I collect the data-set of World Wide soccer matches from year 2011 until 2015 from a British betting consultancy named firm A. All bets placed by display on HK currency, and the odds price also measure based on Hong Kong price.
  
  I tried to apply `RSelenium` on [**RStudio Server Centos7**](http://rstudio.scibrokes.com) to scrape the data from live-score website includes the odds price but the binary [phantomjs](https://github.com/ariya/phantomjs/issues/12948#issuecomment-131267076) is not available for Linux, and I also not familiar with the installation of `Java` as well as setting of the path for `rJava`. Kindly refer to [Natural Language Analysis](http://rpubs.com/englianhu/natural-language-analysis) for more information about the teams name matching.

```{r read-data-summary-table, echo=FALSE, results='asis'}
## Read the datasets
## Refer to **Testing efficiency of coding.Rmd** at chunk `get-data-summary-table-2.1`
years <- seq(2011,2015)

## Here I take the majority leagues setting profile which are "league-10-12"
## fMYPriceB = Back with vigorish price; fMYPriceL = Lay with vigorish price
## Here we term as Fair Odds
lProfile <- c(AH=0.10,OU=0.12)

mbase <- readfirmDatasets(years=years) %>% arrfirmDatasets(., lProfile=lProfile)

## In order to analyse the AHOU, here I need to filter out all soccer matches other than AHOU. (For example : Corners, Total League Goals etc.)
## the stakes amount display as $1 = $10,000
#'@ mbase$datasets[!(mbase$datasets$Home %in% mbase$corners)|!(mbase$datasets$Away %in% mbase$corners),]
dat <- mbase$datasets %>% filter((!Home %in% mbase$others)|(!Away %in% mbase$others)) %>% mutate(Stakes=Stakes/10000, Return=Return/10000, PL=PL/10000, Month=month(ymd(Date), label=TRUE))

#'@ pander(head(dat)) # exactly same layout with kable(x)
#'@ kable(head(dat)) ## example of the dataset in the research paper

dat %>% datatable(.,caption="Table 2.1.1 : Firm A Staking Data",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))

rm(years, readfirmDatasets, arrfirmDatasets)
rm(mbase) ## We need to scrap the livescore data based on the raw data mbase without filter, but this is not the point in this research paper.
```

*table 2.1.1* `r paste(dim(dat), collapse=' x ')`

  In order to analyse the AHOU, here I've filtered out all soccer matches other than AHOU which is the table showing above (For example : Corners, Total League Goals etc.) for whole research paper. Please refer to [Natural Language Analysis](http://rpubs.com/englianhu/natural-language-analysis) to see the firm A staking raw data-set.


### 2.2 Overrounds / Vigorish

  **Fair odds**: the odds that would be offered if the sum of the probabilities for all possible outcomes were exactly 1 (100%). For example, supposing we had a market with three possible outcomes {A, B, C} with probabilities of success $P(A) = 0.5, P(B) = 0.4$ and $P(C) = 0.1$, the fair odds would be `2.00`, `2.50`, and `10.00` respectively, which are just the inverse of the estimated probabilities.

  **Overround**: Also called vigorish (or vig for short) in American sports betting, the over-round is a measure of the bookmaker’s edge over the gambler. The bookmaker will never offer fair odds on a market. In practice, the payout offered on each selection will be reduced, which in turn increases the reflected probability of an event. When odds have been adjusted in this way the sum of the probabilities for all events will exceed 1 `(100%)`. The over-round is the amount by which the sum of all
probabilities exceeds `100%` and it is the bookmaker’s profit margin.

  For example, if we had a market with two possible outcomes {A, B}, where $P(A) = P(B) = 0.5$, the fair odds on each selection would be `2.00`. However, the bookmaker may offer payouts of `1.85` on each selection. The corresponding probabilities for each selection are now 1/1.85 = `r 1/1.85`, and the sum of the probabilities for all outcomes is `r 1/1.85` x 2 = `r 1/1.85*2`. The over-round is `8.1%`, and for every `$100` paid out by gamblers the bookmaker expects to make a profit of `8.1` dollars, assuming that there
are balanced bets on both A and B.

```{r scrap-data, echo=FALSE, results='asis'}
## Scrape the leagues and also overrounds which provides by a sportsbookmaker named Firm B
#'@ lnk <- 'http://data.nowgoal.com/history/handicap.htm'
## Above website provides odds price history but sendkeyElements cannot work in RSelenium, will follow-up
## https://github.com/ropensci/RSelenium/issues/55
## Therefore scrape spbo link to know the league of matches

## Besides, need to scrap the final-scores / half-time scores / result of soccer matches
#'@ dateID <- sort(unique(mbase$datasets$Date)); spboDate <- gsub('-','',dateID)
#'@ lnk <- paste0('http://www8.spbo.com/history.plex?day=',spboDate,'&l=en')
dateID <- sort(unique(dat$Date)); spboDate <- gsub('-','',dateID)

## Due to the scrapSPBO function scrapped unmatched data, example lnk[827],
##  therefore I rewrite the function as scrapSPBO2
#'@ source(paste0(getwd(),'/function/scrapSPBO2.R'))
#'@ scrapSPBO2(lnk=lnk, dateID=dateID, path='livescore', parallel=TRUE)

## Read spbo livescore datasets.
if(dir.exists(paste0(getwd(),'/datasets/livescore'))==FALSE){
  unzip(paste0(getwd(),'/datasets/livescore.zip'),exdir=paste0(getwd(),'/datasets'))
}
spboData <- readSPBO(dateID=dateID, parallel=FALSE)
unlink(paste0(getwd(),'/datasets/livescore'),recursive=TRUE)

## Apply stringdist() to 'exactly matching' and 'approximate matching' team names
#'@ method <- c('osa','lv','dl','hamming','lcs','qgram','cosine','jaccard','jw','soundex')
#'@ source(paste0(getwd(),'/function/arrTeamID.R'))
#'@ tmID <- arrTeamID(mbase, spboData, parallel=FALSE)
tmIDdata <- read.csv(paste0(getwd(),'/datasets/teamID.csv'), header=TRUE, sep=',') %>% mutate_each(funs(as.character)) %>% tbl_df %>% filter(spbo!='Kuban Krasnodar')
spboData %<>% filter((Home %in% tmIDdata$spbo)|(Away %in% tmIDdata$spbo))

rm(dateID, spboDate, readSPBO)
```
  
  I just simply get the lay price by applying below equation.
  
$$P_i^{HK_{Lay}} = 1/P_i^{HK_{Back}}-\nu_{j}$$   *equation 2.2.1*
  
  While $\nu$ is the vigorish and $j={1,2}$ which are `r names(lProfile)[1]`=`r lProfile[1]` and `r names(lProfile)[2]`=`r lProfile[1]`. I have just simply calculated the Layed Fair odds (Odds Price with Vigorish which offer by operators), here I apply a setting profile which is term as `lProfile` (you can casually edit the soccer match profile setting) to get the Real Odds (Net Odds Price without Vigorish). As well as the Value $Value = Real Price/Fair Odds$. Here we can use the Bet Stake Calculator [Kelly Staking Calculator](http://www.sportsbettingcalculator.co.uk/kelly-staking-calculator/). I simply reverse value $\Re$ to get the estimated $P_{i}^{EM}$ (firm A) where we will talk in Section [4.1 Linear Model] and later [4.2 Poisson Modelling] about odds modelling.

```{r data-prob-table1, echo=FALSE, results='asis'}
## Calculate the Real Odds (Net Odds Price without Vigorish)
## fMYPriceB = Back without vigorish net price; netProbL = Lay without vigorish net price
## fMYPriceB adn fMYPriceL are MYPrice, here we term as Real Odds
## Please refer to function arrfirmDatasets()

dat %>% select(No,EUPrice,HKPrice,fHKPriceL,fMYPriceB,fMYPriceL,netProbB,netProbL) %>% head %>% kable(.,caption='Table 2.2.1 : Sample data about virogish/overrounds and also odds price.')
```

*table 2.2.1* `r paste(dim(dat), collapse=' x ')`

  Above *table 2.2.1* just provides some sample about the odds price and over-round while you can refer to [table 2.1.1] for details. Meanwhile, you can know more details about the *return of investment*, *convertion* and also *origin region* based on *same probabilities* among different Odds Types/Styles via [Betting Odds Converter](http://www.sportsbookreview.com/betting-tools/odds-converter/) or just simply google'ing.



## 3. Analyse the Staking Model


### 3.1 Summarise Diversified Periodic Stakes
  
  Before we start analyse the staking model, we are firstly see some diversified periodic breakdown Stakes and Profit & Lose of the Agency A.
  
```{r data-annum-summary-plot, echo=FALSE, results='asis'}
## Annual summry graph.
m <- ddply(dat, .(Sess), summarise, Stakes=sum(Stakes), Return=sum(Return), PL=sum(PL)) %>% tbl_df

gvis.options <- list(title="Annum Stakes & PL ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'Year'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
col.gvis <- gvisColumnChart(xvar='Sess', yvar=c('Stakes','Return','PL'), data=m, options=gvis.options)
plot(col.gvis)

rm(m)
```

*graph 3.1.1* *Annum stakes and return of firm A.*
  
  From the graph above showing that the investment of firm A through agency A generates a positive return (profit). Please refer to [table 4.1.1] for more details about investment analysis.
  
```{r data-month-summary-table, echo=FALSE, results='asis'}
## Monthly summary table.
dt1 <- dat %>% group_by(Sess, Month) %>% summarise(S.total=sum(Stakes), S.median=median(Stakes), S.mean=round(mean(Stakes),4), S.sd=round(sd(Stakes),4), Count=length(PL), minHKPrcB=min(HKPrice), maxHKPrcB=max(HKPrice), minProbB=min(netProbB), maxProbB=max(netProbB), Return=sum(PL,Stakes), PL=sum(PL), PL.percent=sprintf(sum(PL)/sum(Stakes),fmt='%1.4f%%'), Samples=paste(Stakes, collapse=',')) %>% mutate(Series=Samples)
names(dt1)[1] <- 'Sess'
ddim <- dim(dt1)

r <- dt1 %>% group_by(Sess, Month) %>% .$Stakes %>% range

line_string <- "type: 'line', lineColor: 'black', fillColor: '#ccc', highlightLineColor: 'orange', highlightSpotColor: 'orange'"

cb_line <- JS(paste0("function (oSettings, json) { $('.spark:not(:has(canvas))').sparkline('html', { ", line_string, ", chartRangeMin: ", r[1], ", chartRangeMax: ", r[2], " }); }"), collapse = "")

box_string <- "type: 'box', lineColor: 'black', whiskerColor: 'black', outlierFillColor: 'black', outlierLineColor: 'black', medianColor: 'black', boxFillColor: 'orange', boxLineColor: 'black'"

cd <- list(list(targets=15, render=JS("function(data, type, full){ return '<span class=sparkSamples>' + data + '</span>' }")), list(targets=16, render=JS("function(data, type, full){ return '<span class=sparkSeries>' + data + '</span>' }")))

cb = JS(paste0("function (oSettings, json) {\n  $('.sparkSeries:not(:has(canvas))').sparkline('html', { ", line_string, " });\n  $('.sparkSamples:not(:has(canvas))').sparkline('html', { ", box_string, " });\n}"), collapse = "")

dt1 %<>% datatable(.,caption="Table 3.1.1 : Summary of Monthly Stakes and Return. ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE, columnDefs=cd, fnDrawCallback=cb))

## convert the data into inline graph
dt1$dependencies <- append(dt1$dependencies, htmlwidgets:::getDependency('sparkline'))
dt1

rm(dt1, r)
```

*table 3.1.1* `r paste(unlist(strsplit(as.character(ddim),' ')), collapse=' x ')`

  From the table above, we realized that the Asian agency A make profit by follow the British sports betting consultancy firm A every year. Since thousands of bets (and maximum bet limit setting, league profile setting, and also value betting which properly based on Kelly model, mean value will be kinda bias) placed per month, here we take median will be accurate than mean value.

```{r data-month-summary-plots, echo=FALSE, results='asis'}
## Monthly summary graph.
## the stakes amount display as $1 = $10,000
m <- ddply(data.frame(Month=as.yearmon(dat$Date,'%b'),dat), .(Month), summarise, Stakes=sum(Stakes)/10000, Return=sum(Return)/10000, PL=sum(PL)/10000) %>% tbl_df %>% mutate(Month=as.character(Month)) # mutate Month as.character at last to make the Month hAxis arrange in order after summarise

gvis.options <- list(title="Monthly Stakes & PL ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'Month'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='Month', yvar=c('Stakes','Return','PL'), data=m, options=gvis.options)
plot(line.gvis)

rm(m)
```

*graph 3.1.2* *Monthly stakes and return of firm A.*

```{r data-daily-summary, echo=FALSE, results='asis'}
dt2 <- dat %>% group_by(Sess, Month, Day) %>% summarise(S.total=sum(Stakes), S.median=median(Stakes), S.mean=round(mean(Stakes),4), S.sd=round(sd(Stakes),4), Count=length(PL), minHKPrcB=min(HKPrice), maxHKPrcB=max(HKPrice), minProbB=min(netProbB), maxProbB=max(netProbB), Return=sum(PL,Stakes), PL=sum(PL), PL.percent=sprintf(sum(PL)/sum(Stakes),fmt="%1.4f%%"), Samples=paste(Stakes, collapse=",")) %>% mutate(Series=Samples)
names(dt2)[1] <- 'Sess'
ddim <- dim(dt2)

## Coy for plot graph
m <- dt2 %>% mutate(Day=paste(Day,Month,Sess)) %>% select(Day, Stakes=S.total, Return, PL)

r <- dt2 %>% group_by(Sess, Month, Day) %>% .$Stakes %>% range

cb_line <- JS(paste0("function (oSettings, json) { $('.spark:not(:has(canvas))').sparkline('html', { ", line_string, ", chartRangeMin: ", r[1], ", chartRangeMax: ", r[2], " }); }"), collapse = "")

cb = JS(paste0("function (oSettings, json) {\n  $('.sparkSeries:not(:has(canvas))').sparkline('html', { ", line_string, " });\n  $('.sparkSamples:not(:has(canvas))').sparkline('html', { ", box_string, " });\n}"), collapse = "")

dt2 %<>% datatable(.,caption="Table 3.1.2 : Summary of Daily Stakes and Return. ('0,000)", rownames=FALSE, extensions=c('ColReorder','ColVis','TableTools'), options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)), scrollX=TRUE,scrollCollapse=TRUE, columnDefs=cd, fnDrawCallback=cb))

## convert the data into inline graph
dt2$dependencies <- append(dt2$dependencies, htmlwidgets:::getDependency('sparkline'))
dt2

rm(dt2, r, line_string, cb_line, box_string, cd, cb)
```

*table 3.1.2* `r paste(unlist(strsplit(as.character(ddim),' ')), collapse=' x ')`

```{r data-daily-summary-plot, echo=FALSE, results='asis'}
## Daily summary graph.
## the stakes amount display as $1 = $10,000
gvis.options <- list(title="Daily Stakes & PL ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'Day'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='Day', yvar=c('Stakes','Return','PL'), data=m, options=gvis.options)
plot(line.gvis)

rm(ddim, line.gvis, m)
```

*graph 3.1.3*  *Daily stakes and return of firm A.*
  
  From the graph above, we can easily know the figure of Stakes, Returns and Profit & Lose while below table separate into daily breakdown. The table shows the daily stakes and also quantile values.
  
  
### 3.2 Analyse the Staking Handicap

```{r data-hdp-summary-table1a, echo=FALSE, results='asis'}
## Handicap breakdown summary
funs <- expression(sum, mean, median, sd, length)

ahBets <- llply(funs, function(x)
    ddply(dat, ~HCap+AHOU+Picked, .drop=TRUE, colwise(.fun=x, .cols=~Stakes+Return+PL))) %>% join_all(by=c('HCap','AHOU','Picked')) %>% .[-c((ncol(.)-1):ncol(.))] %>% tbl_df

names(ahBets) <- suppressWarnings(c('HCap','AHOU','Picked','Stakes','Return','PL','S.mean','R.mean','PL.mean','S.median','R.median','PL.median','S.sd','R.sd','PL.sd','Count'))

ahBets %<>% map_if(is.numeric,round,2) %>% mutate(R.percent=sprintf(Return/Stakes,fmt='%1.4f%%'), PL.percent=sprintf(PL/Stakes,fmt='%1.4f%%'))

lst <- ahBets %>% dlply(.(AHOU))
lst[[1]] %>% datatable(.,caption="Table 3.2.1A : Asian Handicap - Handicap Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip', colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 3.2.1a* `r dlply(ahBets,.(AHOU),dim) %>% .[[1]] %>% paste0(.,collapse=' x ')`

```{r data-hdp-summary-table1b, echo=FALSE, results='asis'}
lst[[2]] %>% datatable(.,caption="Table 3.2.1B : Goal Line - Handicap Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip', colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 3.2.1b* `r dlply(ahBets,.(AHOU),dim) %>% .[[2]] %>% paste0(.,collapse=' x ')`

```{r data-hdp-summary-table1c, echo=FALSE, results='asis'}
m <- ddply(dat, ~HCap+AHOU, .drop=TRUE, colwise(.fun=sum, .cols=~Stakes+Return+PL)) %>% mutate(R.percent=sprintf(Return/Stakes, fmt='%1.4f%%'), PL.percent=sprintf(PL/Stakes, fmt='%1.4f%%')) %>% dlply(., .(AHOU)) %>% llply(arrange, Stakes) %>% ldply(tail, .id=NULL)
m %>% kable(., caption='Table 3.2.1c : Sample data about Handicap, Stakes and PL.')
```

*table 3.2.1c* `r paste0(dim(m),collapse=' x ')`

  From above tables, firm A mostly placed on Asian Handicap range concedes/taken `r m %>% filter(Stakes==max(Stakes), AHOU=='AH') %>% .$HCap` ball on agency A. Menwhile the odds `r m %>% filter(AHOU=='AH', R.percent==max(R.percent)) %>% .$HCap` is most profitable from return rate.

  Secondly, from the Goal Line mostly taking `r ahBets %>% filter(AHOU=='OU') %>% filter(Stakes==max(Stakes)) %>% .$Picked` selection on `r ahBets %>% filter(AHOU=='OU') %>% filter(Stakes==max(Stakes)) %>% .$HCap` balls. (Since Dutch, Japanese, Spanish and Women soccer leagues always scoring more goals, but Portuguese, Italian, French leagues always score less, English leagues average `2.5` balls)

```{r data-hdp-summary-plot1a, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on AH handicap graphs
## the stakes amount display as $1 = $10,000
lst <- ahBets %>% select(HCap, AHOU, Picked, Stakes, Return, PL) %>% dlply(.(AHOU), gather, Type, Stakes, Stakes:PL) %>% llply(unite, Category, Picked, Type, sep='.') %>% llply(spread, Category, Stakes) %>% llply(tbl_df)

gvis.options <- list(title="Asian Handicap - Handicap Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'HCap'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='HCap', yvar=names(lst[[1]])[-c(1:2)], data=lst[[1]], options=gvis.options)
plot(line.gvis)

rm(ahBets, line.gvis)
```

*graph 3.2.1a*

```{r data-hdp-summary-plot1b, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on OU handicap graphs
## the stakes amount display as $1 = $10,000
gvis.options <- list(title="Goal Line - Handicap Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'HCap'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='HCap', yvar=names(lst[[2]])[-c(1:2)], data=lst[[2]], options=gvis.options)
plot(line.gvis)

rm(line.gvis)
```

*graph 3.2.1b*

  Now we look at the graph above, we can know the Stakes breakdown on both `r names(lProfile)[1]` and `r names(lProfile)[2]`.


### 3.3 Analyse the Staking Prices

```{r data-hdp-summary-table2a, echo=FALSE, results='asis'}
## Favorite or Underdog and price range breakdown
fuBets <- llply(funs, function(x)
    ddply(dat, ~AHOU+pHKRange+Picked, .drop=TRUE, colwise(.fun=x, .cols=~Stakes+Return+PL))) %>% join_all(by=c('AHOU','pHKRange','Picked')) %>% .[-c((ncol(.)-1):ncol(.))] %>% tbl_df

names(fuBets) <- suppressWarnings(c('AHOU','pHKRange','Picked','Stakes','Return','PL','S.mean','R.mean','PL.mean','S.median','R.median','PL.median','S.sd','R.sd','PL.sd','Count'))

fuBets %<>% map_if(is.numeric,round,2) %>% mutate(R.percent=sprintf(Return/Stakes,fmt='%1.4f%%'), PL.percent=sprintf(PL/Stakes,fmt='%1.4f%%'))

lst <- fuBets %>% dlply(.(AHOU))
lst[[1]] %>% datatable(.,caption="Table 3.3.1A : Asian Handicap - Price Range Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip', colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 3.3.1a* `r dlply(fuBets,.(AHOU),dim) %>% .[[1]] %>% paste0(.,collapse=' x ')`

```{r data-hdp-summary-table2b, echo=FALSE, results='asis'}
lst[[2]] %>% datatable(.,caption="Table 3.3.1B : Goal Line - Price Range Breakdown ",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip', colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 3.3.1b* `r dlply(fuBets,.(AHOU),dim) %>% .[[2]] %>% paste0(.,collapse=' x ')`

```{r data-hdp-summary-table2c, echo=FALSE, results='asis'}
m <- ddply(dat, ~pHKRange+pMYRange, .drop=TRUE, colwise(.fun=sum, .cols=~Stakes+Return+PL)) %>% mutate(R.percent=sprintf(Return/Stakes,fmt='%1.4f%%'), PL.percent=sprintf(PL/Stakes,fmt='%1.4f%%')) %>% .[6:12,] %>% tbl_df
m %>% kable(.,caption='Table 3.3.1c : Sample data about Price Range, Stakes and PL.')
```

*table 3.3.1c* `r paste0(dim(m),collapse=' x ')`

  From above tables, the price range on `r m %>% filter(Stakes==max(Stakes)) %>% .$pHKRange %>% as.character` are mostly been placed. We try to compare the stakes between `0.70~0.80` and `1.10~1.20`, `0.60~0.70` and `1.20~1.30` and the returns/profit, we will know the price is importance on **Value Betting**.

```{r data-hdp-summary-plot2a, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on AH handicap graphs
## the stakes amount display as $1 = $10,000
lst <- fuBets %>% select(AHOU, pHKRange, Picked, Stakes, Return, PL) %>% dlply(.(AHOU), gather, Type, Stakes, Stakes:PL) %>% llply(unite, Category, Picked, Type, sep='.') %>% llply(spread, Category, Stakes) %>% llply(tbl_df)

gvis.options <- list(title="Asian Handicap - Price Range Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'pHKRange'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='pHKRange', yvar=names(lst[[1]])[-c(1:2)], data=lst[[1]], options=gvis.options)
plot(line.gvis)

rm(fuBets, line.gvis)
```

*graph 3.3.1a*

```{r data-hdp-summary-plot2b, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on OU handicap graphs
## the stakes amount display as $1 = $10,000
gvis.options <- list(title="Goal Line - Price Range Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'pHKRange'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='pHKRange', yvar=names(lst[[2]])[-c(1:2)], data=lst[[2]], options=gvis.options)
plot(line.gvis)

rm(line.gvis)
```

*graph 3.3.1b*
  
  Above graph shows the Stakes and P&L on different price range in MY Odds style. In fact the MY Odds Style will be easier to count and understand in statistics as well as plot graph since the return (both won and lost) will be ONLY from `-1` to `1` while HK/Europe Odds Style will count from `-1` to `Inf`. However I keep both HKOdds and MYOdds Please refer to [table 2.2.1] for more details.
  
  However, due to consideration of the stakes amount, here I just simply use the HK in order to make the Stakes and Return/PL exactly same with the dataset.


### 3.4 Analyse the In-Play Stakes

```{r data-ip-summary-table1a, echo=FALSE, results='asis'}
## In-Play : time range
funs <- expression(sum, mean, median, sd, length)
ipBets1 <- llply(funs, function(x)
    ddply(dat, ~InPlay2+AHOU+ipRange, .drop=TRUE, colwise(.fun=x, .cols=~Stakes+Return+PL))) %>% join_all(by=c('InPlay2','AHOU','ipRange')) %>% .[-c((ncol(.)-1):ncol(.))] %>% tbl_df

names(ipBets1) <- suppressWarnings(c('InPlay2','AHOU','ipRange','Stakes','Return','PL','S.mean','R.mean','PL.mean','S.median','R.median','PL.median','S.sd','R.sd','PL.sd','Count'))

ipBets1 %<>% map_if(is.numeric,round,2) %>% mutate(R.percent=sprintf(Return/Stakes,fmt='%1.4f%%'), PL.percent=sprintf(PL/Stakes,fmt='%1.4f%%'))

lst <- ipBets1 %>% dlply(.(AHOU))
lst[[1]] %>% datatable(.,caption="Table 3.4.1A : Asian Handicap - InPlay Time Range Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip', colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))

rm(funs)
```

*table 3.4.1a* `r llply(split(ipBets1,ipBets1$AHOU), function(x) paste(unlist(strsplit(as.character(dim(x)),' ')), collapse=' x '))[[1]]`

```{r data-ip-summary-table1b, echo=FALSE, results='asis'}
lst[[2]] %>% datatable(.,caption="Table 3.4.1B : Goal Line - InPlay Time Range Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip', colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 3.4.1b* `r llply(split(ipBets1,ipBets1$AHOU), function(x) paste(unlist(strsplit(as.character(dim(x)),' ')), collapse=' x '))[[2]]`
  
  The table above shows the breakdown stakes on `Breaks` includes pregames of Extra-Time (started 90 minutes games), Half-Time and Full-Time in both 90 minutes games and also Extra-Time, Injuries-Time, Breaks-Time etc (All stakes after blew game-start whistle and before final result). While `No` means pre-games stakes and P&L summary.

```{r data-ip-summary-plots1a, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on AH handicap graphs
## the stakes amount display as $1 = $10,000
lst <- ipBets1 %>% select(InPlay2, AHOU, ipRange, Stakes, Return, PL) %>% dlply(.(AHOU), gather, Type, Stakes, Stakes:PL) %>% llply(unite, Category, InPlay2, Type, sep='.') %>% llply(spread, Category, Stakes) %>% llply(tbl_df)

gvis.options <- list(title=" Asian Handicap - InPlay Time Range Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'ipRange'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='ipRange', yvar=names(lst[[1]])[-c(1:2)], data=lst[[1]], options=gvis.options)
plot(line.gvis)

rm(ipBets1, line.gvis)
```

*graph 3.4.1a*

```{r data-ip-summary-plots1b, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on OU handicap graphs
## the stakes amount display as $1 = $10,000
gvis.options <- list(title="Goal Line - InPlay Time Range Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'ipRange'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='ipRange', yvar=names(lst[[2]])[-c(1:2)], data=lst[[2]], options=gvis.options)
plot(line.gvis)

rm(line.gvis)
```

*graph 3.4.1b*
  
  From the above graph shows the In-Play stakes, the first `(0,10]` time range placed most stakes while `(55,60]` start dropping. The `<NA>` includes all stakes when the soccer players are not playing on the football field. (Pre-games, Half-Time, Full-Time, Extra-Time, Injuries Time, Breaks Time etc.)

```{r data-ip-summary-table2a, echo=FALSE, results='asis'}
## In-Play : time range, current score, current ah/ou and also picked home team or favorite team etc.
funs <- expression(sum, mean, median, sd, length)
ipBets2 <- llply(funs, function(x)
    ddply(dat, ~InPlay2+HCap+AHOU+CurScore+ipHCap+ipRange+Picked+Picked2, .drop=TRUE, colwise(.fun=x, .cols=~Stakes+Return+PL))) %>% join_all(by=c('InPlay2','HCap','AHOU','CurScore','ipHCap','ipRange','Picked','Picked2')) %>% .[-c((ncol(.)-1):ncol(.))] %>% tbl_df

names(ipBets2) <- suppressWarnings(c('InPlay2','HCap','AHOU','CurScore','ipHCap','ipRange','Picked','Picked2','Stakes','Return','PL','S.mean','R.mean','PL.mean','S.median','R.median','PL.median','S.sd','R.sd','PL.sd','Count'))

ipBets2 %<>% map_if(is.numeric,round,2) %>% mutate(R.percent=sprintf(Return/Stakes,fmt='%1.4f%%'), PL.percent=sprintf(PL/Stakes,fmt='%1.4f%%'))

lst <- ipBets2 %>% dlply(.(AHOU))
lst[[1]] %>% datatable(.,caption="Table 3.4.2A : Asian Handicap - InPlay Current Score and Handicap Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))

rm(funs)
```

*table 3.4.2a* `r llply(split(ipBets2,ipBets2$AHOU), function(x) paste(unlist(strsplit(as.character(dim(x)),' ')), collapse=' x '))[[1]]`

```{r data-ip-summary-table2b, echo=FALSE, results='asis'}
lst[[2]] %>% datatable(.,caption="Table 3.4.2B : Goal Line - InPlay Current Score and Handicap Breakdown ('0,000)",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 3.4.2b* `r llply(split(ipBets2,ipBets2$AHOU), function(x) paste(unlist(strsplit(as.character(dim(x)),' ')), collapse=' x '))[[2]]`

  Above table shows a further details breakdown of In-Play stakes, includes the current scores and also current concedes/given handicap during In-Play while <NA> during Break means Break-Time or pre-Extra-Time etc. The complete data is dim(sample.data) `r llply(split(ipBets2,ipBets2$AHOU), function(x) paste(unlist(strsplit(as.character(dim(x)),' ')), collapse=' x '))` for both AH and OU.

```{r data-ip-summary-plots2a, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on AH handicap graphs
## the stakes amount display as $1 = $10,000

##
## Errors: need to be reviewed
##
#'@ lst <- ipBets2 %>% select(AHOU, CurScore, ipHCap, ipRange, Picked, Stakes, Return, PL) %>% dlply(.(AHOU), gather, Type, Stakes, Stakes:PL) %>% llply(unite, Category, Picked, Type, sep='.') %>% llply(spread, Category, Stakes) %>% llply(tbl_df)

gvis.options <- list(title="Asian Handicap - InPlay Current Score and Handicap Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'CurScore'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='CurScore', yvar=names(lst[[1]])[-c(1:2)], data=lst[[1]], options=gvis.options)
plot(line.gvis)

rm(ipBets2, line.gvis)
```

*graph 3.4.2a*

```{r data-ip-summary-plots2b, echo=FALSE, results='asis'}
## Plot the Stakes and P&L on OU handicap graphs
## the stakes amount display as $1 = $10,000
gvis.options <- list(title="Goal Line - InPlay Current Score and Handicap Breakdown ('0,000)", series="[{targetAxisIndex:0},{targetAxisIndex:1}]",hAxis="{title:'CurScore'}", vAxis="{title:'Stakes'},{title:'PL'}",width='automatic', height='automatic')
line.gvis <- gvisLineChart(xvar='CurScore', yvar=names(lst[[2]])[-c(1:2)], data=lst[[2]], options=gvis.options)
plot(line.gvis)

rm(line.gvis)
```

*graph 3.4.2b*



## 4. Staking Model


### 4.1 Linear Model

  Before we start modelling, we look at the summary of investment return rates based on data-set `dat`.

```{r data-return-summary-table1, echo=FALSE, results='asis'}
## Get the investment return rates per annun
## http://www.math.ku.dk/~rolf/teaching/thesis/DixonColes.pdf
## value returnRates is based on annual EMProb/netProb ratio, while EMProb get from equation 4.1.2
returnRates <- ddply(dat, .(Sess), summarise, Stakes=sum(Stakes), Return=sum(Return), n=length(Sess), returnRates=Return/Stakes)
returnRates %>% kable(.,caption='Table 4.1.1 : Annual Return of Staking Data.')
```

*table 4.1.1* `r paste(unlist(strsplit(as.character(dim(returnRates)),' ')), collapse=' x ')`

$$\Re = \sum_{i=1}^{n}\rho_{i}^{EM}/\sum_{i=1}^{n}\rho_{i}^{BK}$$   *equation 4.1.1*

  $\Re$ is the return rates of investment. The $\rho_i^{EM}$ is the estimated probabilities which is the calculated by firm A from match 1,2... until n matches while $\rho_{i}^{BK}$ is the net/pure probability (real odds) offer by bookmakers after we fit the *equation 4.1.2* into *equation 4.1.1*.

$$\rho_i = P_i^{Lay} / (P_i^{Back} + P_i^{Lay})$$   *equation 4.1.2*

$P_i^{Back}$ and $P_i^{Lay}$ is the backed and layed fair price offer by bookmakers.

  We can simply apply equation above to get the value $\Re$. From the table above we know that the EMPrice calculated by firm A **invested** at a threshold edge (price greater) `r returnRates$returnRates` than the prices offer by bookmakers. There are some description about $\Re$ on [Dixon&Coles1996](http://www.math.ku.dk/~rolf/teaching/thesis/DixonColes.pdf).

```{r data-prob-table2, echo=FALSE, results='asis'}
dat$rEMProbB <- round(rep(returnRates$returnRates,returnRates$n)*dat$netProbB,4)
dat$rEMProbL <- 1 - round(dat$rEMProbB,4)

## To know the true value price of favorite/over or underdog/under 
dat$favNetProb <- ifelse(dat$Picked=='favorite'|dat$Picked=='over' , dat$netProbB, dat$netProbL)
dat$undNetProb <- ifelse(dat$Picked=='underdog'|dat$Picked=='under', dat$netProbB, dat$netProbL)

#'@ dat$favNetProb*log(1+mbase$Return*dat$Stakes) + dat$undNetProb*log(1+dat$Return*dat$Stakes)
#'@ dat[c('Stakes','Result','Return','PL','Rebates')]

dat %>% select(No,EUPrice,HKPrice,fHKPriceL,fMYPriceB,fMYPriceL,netProbB,netProbL,rEMProbB,rEMProbL,favNetProb,undNetProb) %>% datatable(.,caption="Table 4.1.2 : Probabilities Table",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))
```

*table 4.1.2* `r paste(unlist(strsplit(as.character(dim(dat)),' ')), collapse=' x ')`

  The above table list the odds prices and probabilities of `i` soccer matches while `n` indicates the number of soccer matches.

```{r data-prob-plot2, echo=FALSE, results='asis'}
## Linear model
## Learn about API authentication here: https://plot.ly/r/getting-started
## Find your api_key here: https://plot.ly/settings/api

#'@ model <- lm(rEMProbB ~ netProbB, data=dat)
#'@ grid <- with(dat, expand.grid(netProbB = seq(min(netProbB), max(netProbB), length = 20),
#'@                                 rEMProbB = seq(min(rEMProbB), max(rEMProbB), length = 20)))
#'@ grid$rEMProb <- stats::predict(model, newdata=grid)
#'@ viz2 <- qplot(netProbB, rEMProbB, data=dat) + geom_point(data=grid)
#'@ out <- ggplotly(viz2)
#'@ plotly_url <- out$response$url

#'@ ggplot(dat, aes(x = netProbB, y = rEMProbB)) + geom_point(aes(y = netProbB, color = 'netProbB')) + geom_point(aes(y = rEMProbB, color = 'rEMProbB')) + xlab('Bookmaker Backed Net Prob') + ylab('Calculated EM Backed Prob') + theme_economist(base_family='Verdana') + scale_colour_economist() + ggtitle('Bookmaker Net Probabilities -vs- Firm A EM Probabilities')
```

*graph 4.1.1*

  Graph above shows the probabilities calculated by firm A to back against real probabilities offered by bookmakers over `r nrow(dat)` soccer matches.

  Now we look at the result of the soccer matches.

```{r data-return-summary-table2, echo=FALSE, results='asis'}
## http://www.statmethods.net/stats/frequencies.html
## prop.table, margin.table
## margin.table(table(dat$Result),1)
##
## library('gmodels')
## CrossTable(dat$HCap, dat$Result)
##
mResult <- ddply(dat, .(Result), summarise, Stakes=sum(Stakes), Return=sum(Return), Rates=Return/Stakes, n=length(Sess)) %>% tbl_df %>% mutate(S.prop=round(Stakes/sum(Stakes),4), R.prop=round(Return/sum(Return),4), prop=round(n/sum(n),4))
tv <- c('Total',colSums(mResult[-1])); tv[4] <- as.numeric(tv[3])/as.numeric(tv[2])
mResult <- suppressWarnings(rbind(mResult,tv))
mResult$Result <- factor(c(as.character(mResult$Result)[-length(mResult$Result)],'Total')); rm(tv)
mResult %>% kable(.,caption='Table 4.1.3 : Annual Return Summary of Staking Data.')
```

*table 4.1.3* `r paste(unlist(strsplit(as.character(dim(mResult)),' ')), collapse=' x ')`

  The table above summarize the stakes and return on soccer matches result.

```{r data-preMatch, echo=FALSE, results='asis'}
##
## Calculate the proportional model on the results, which are 'Cancelled', 'Half-Loss', 'Half-Win', 'Loss', 'Push', 'Win'.
## Ommited the InPlay matches, filter out the sample data, only Pre-Games matches taken into further calculations.
preData <- subset(dat, InPlay=='No' & InPlay2=='No')
hdp <- sort(unique(as.numeric(as.character(dat$HCap))))
hdp
```

  Due to the soccer matches randomly getting from different leagues, and also not Bernoulli win-lose result but half win-lose etc as we see from above. Besides, there were mixed Pre-Games and also In-Play soccer matches and I filter-up the sample data to be `r paste(dim(preData), collapse=' x ')`. I don't pretend to know the correct answer or the model from firm A. However I take a sample presentation [An introduction to football modelling at Smartodds](https://people.maths.ox.ac.uk/siamstudentchapter/webpages/2011_Conference/Robert_Talk.pdf) from one of consultancy firm which is Dixon-Coles model and omitted the scoring process section.

  Here I cannot reverse computing from barely $\rho_i^{EM}$ without know the $\lambda_{ij}$ and $\gamma$ values. Therefore I try to using both Home and Away Scores to simulate and test to get the maximum likelihood $\rho_i^{EM}$.

$$X_{ij} = pois(\gamma \alpha_{ij} \beta_{ij} ); Y_{ij} = pois(\alpha_{ij} \beta_{ij})$$   *equation 4.1.3*

  The Poisson model will be touched in next section 4.2.


### 4.2 Poisson Modelling

  Here we introduce the [Dixon & Coles 1996](http://www.math.ku.dk/~rolf/teaching/thesis/DixonColes.pdf) Poisson model and its codes. You are freely learning from below links if interest.

- [Dixon and Cole's Poisson regression R Packages](http://lastplanetranking.blogspot.com/2013/11/code.html)
- [Dixon and Coles Poisson model](http://opisthokonta.net/?p=890)
- [Dixon Coles model - Python](http://www.sportshacker.net/posts/simple_dixon_coles.html)
- [Predicting Football Using R](http://pena.lt/y/2014/11/02/predicting-football-using-r/)

```{r data-Poisson, echo=FALSE, results='asis'}
## Apply Poisson model to simulate different scores to maximum likelihood value ρ.
## reverse Kelly Criterion to abtain the average EMPrice, reversed bivarite poisson to get the EMprobB
##
## benchmarking logistic regression using glm.fit , bigglm, speedglm, glmnet, LiblineaR
## http://stackoverflow.com/questions/19532651/benchmarking-logistic-regression-using-glm-fit-bigglm-speedglm-glmnet-libli
##
## Test if placed multiple bets on same match
#'@ preData[duplicated(preData[c('Date','Home','Away')]),c('Date','Home','Away','HG','AG','InPlay','InPlay2','Mins','Mins2','Picked2')]

```

  sample...


### 4.3 Kelly Model

  From the papers [Niko Marttinen2001](http://www.ylikerroin.com/file/Complete.pdf) and [Jeffrey Alan Logan Snyder 2013](http://homes.cs.washington.edu/~jasnyder/papers/thesis.pdf) both applying **Full-Kelly**,**Half-Kelly** and also **Quarter-Kelly** models which similar with my previous Kelly-Criterion model [englianhu2014](http://rpubs.com/englianhu/kelly_eng1112) but enhanced.

  To achieve the level of profitable betting, one must develop a correct money management procedure. The aim for a punter is to maximize the winnings and minimize the losses. If the punter is capable of predicting accurate probabilities for each match, the [Kelly criterion](http://www.eecs.harvard.edu/cs286r/courses/fall12/papers/Thorpe_KellyCriterion2007.pdf) has proven to work effectively in betting. It was named after an American economist [John Kelly (1956)](http://ieeexplore.ieee.org/stamp/stamp.jsp?reload=true&tp=&arnumber=6771227) and originally designed for information transmission. The Kelly criterion is described below:

$$S=(\rho*\sigma-1)/(\sigma-1)$$   *equation-4.3.1*

  Where S = the stake expressed as a fraction of one's total bankroll, $\rho$ = probability of an event to take place, $\sigma$ = odds for an event offered by the bookmaker. Three important properties, mentioned by Hausch and Ziemba (1994) ([Efficiency of Racetrack Betting Markets (2008Edition)](http://stocksfirst.com/books/trading-econ-investing/Efficiency%20of%20Racetrack%20Betting%20Mkts%20-%20Ziemba%202008.pdf)), arise when using this criterion to determine a proper stake for each bet:

- It maximizes the asymptotic growth rate of capital

- Asymptotically, it minimizes the expected time to reach a specified goal

- It outperforms in the long run any other essentially different strategy almost surely

  The criterion is known to economists and financial theorists by names such as the geometric mean maximizing portfolio strategy, the growth-optimal strategy, the capital growth criterion, etc. We will now show that Kelly betting will maximize the expected log utility for sports-book betting.

```{r data-Kelly, echo=FALSE, results='asis'}
## Kelly Criterion model
##
## 1. Summarise the data which group by Date
accBets <- ddply(dat, .(Date), summarise, Stakes=sum(Stakes), S.median=median(Stakes),
                S.mean=mean(Stakes), S.sd=sd(Stakes), Count=length(PL), PL=sum(PL), PL.percent=(PL/Stakes))

## 2. Set initial bankroll as 1,000,000
dat$iniBR <- c(1000000,cumsum(dat$Return[-1]))
dat$K <- ((dat$EUPrice+1)*dat$rEMProbB-1)/(dat$EUPrice)

exp(mean(log(dat$Stakes)))

```

$$K = \frac{(B + 1)p - 1} {B}$$   *equation 4.3.1*

$$G: = \mathop {\lim }\limits_{N \to \infty } \frac{1/N}{\log}\left( {\frac{{{BR_N}}}{{{BR_0}}}} \right)$$   *equation 4.3.2*

$$BR_N = (1 + K)^W(1 - K)^L BR_0$$   *equation 4.3.3*

  Kelly K-value [凯利模式资金管理](http://ch-hsieh.blogspot.com/2015/01/kelly-criterion-0.html)


### 4.4 Staking Modelling and Money Management

```{r, echo=FALSE, results='asis'}
## Bootstrap and apply maximum likelihood model
## Full-Kelly, Half-Kelly, Quarter-Kelly

```

  sample...


### 4.5 Expectation Maximization and Staking Simulation

```{r, echo=FALSE, results='asis'}
## Apply Poison model to simulate the result of the matches
## Apply the Kelly model (iterations) to test the efficiency of the value betting from  Sportsbook consultancy firm A
## Apply poisson model to simulate different scores and result to test the efficiency of the staking model.
## reverse Kelly Criterion to abtain the average EMPrice, reversed bivarite poisson to get the EMprobB

```

  sample...



## 5. Result


### 5.1 Comparison of the Results

Chapter 4.2 Comparison of Different Feature Sets and Betting Strategies in []()

```{r, echo=FALSE, results='asis'}
## Bootstrap and apply maximum likelihood model 
## http://www.r-bloggers.com/apple-compared-to-others-with-ggthemes/
#'@ 
#'@ kable(dat) ##knit table
```

  [Dixon&Pope2003](http://www.sciencedirect.com/science/article/pii/S016920700400010X) apply linear model to compare the efficiency of the odds prices offer by first three largest Firm A, B and C in UK.


### 5.2 Market Basket

  Here I apply the `arules` and `arulesViz` packages to analyse the market basket of the bets.

```{r, echo=FALSE, results='asis'}
## Set options back to original options
options(op)
```



## 6. Conclusion


### 6.1 Conclusion

  Due to the data-sets I collected just one among all agents among couple sports-bookmakers [4lowin](https://www.youtube.com/watch?v=eFYS0jdSiWc). Here I cannot determine if the sample data among the population...


### 6.2 Future Works
  
  I will be apply Shiny to write a dynamic website to utilise the function as web based apps. You are welcome to refer [SHOW ME SHINY](http://www.showmeshiny.com/category/topics/sports/).
  
  I will also write as a package to easier load and log.



## 7. Appendices

  
### 7.1 Documenting File Creation 

It's useful to record some information about how your file was created.
  
  * File creation date: 2015-07-22
  * `r R.version.string`
  * R version (short form): `r getRversion()`
  * `rmarkdown` package version: `r packageVersion('rmarkdown')`
  * File version: 1.0.0
  * File latest updated date: `r Sys.Date()`
  * Author Profile: [Ryo®, Eng Lian Hu](http://rpubs.com/englianhu/ryoeng)
  * GitHub: [Source Code](https://github.com/Scibrokes/Betting-Strategy-and-Model-Validation/blob/master/Betting%20Strategy%20and%20Model%20Validation.Rmd)
  * Additional session information
  
```{r echo=FALSE, results='asis'}
lubridate::now()
devtools::session_info()$platform
Sys.info()
```



## References
  
  * [Creating a Profitable Betting Strategy for Football by Using Statistical Modelling](http://www.ylikerroin.com/file/Complete.pdf)
  * [What Actually Wins Soccer Matches: Prediction of the 2011-2012 Premier League for Fun and Profit](http://homes.cs.washington.edu/~jasnyder/papers/thesis.pdf)
  * [The value of statistical forecasts in the UK association football betting market](http://www.sciencedirect.com/science/article/pii/S016920700400010X)
  * [Dixon and Cole's Poisson regression R Packages](http://lastplanetranking.blogspot.com/2013/11/code.html)
  * [Apply Kelly-Criterion on English Soccer 2011/2012](http://rpubs.com/englianhu/kelly_eng1112)
  * [Apply Kelly-Criterion on English Soccer 2012/2013](http://rpubs.com/englianhu/kelly_eng1213)
  * [An introduction to football modelling at Smartodds](https://people.maths.ox.ac.uk/siamstudentchapter/webpages/2011_Conference/Robert_Talk.pdf)
  * [The Betting Machine](http://www.diva-portal.org/smash/get/diva2:655630/fulltext01.pdf)
  * [The Kelly Criterion in Blackjack Sports Betting, and the Stock Market](http://www.eecs.harvard.edu/cs286r/courses/fall12/papers/Thorpe_KellyCriterion2007.pdf)
  * [Statistical Methodology for Profitable Sports Gambling](https://www.stat.sfu.ca/content/dam/sfu/stat/alumnitheses/2012/FabianMoyaFinalVersion.pdf)
  * [How to apply the Kelly criterion when expected return may be negative?](http://quant.stackexchange.com/questions/2500/how-to-apply-the-kelly-criterion-when-expected-return-may-be-negative)
  * [Money Management Using The Kelly Criterion](http://www.investopedia.com/articles/trading/04/091504.asp)
  * [Optimal Exchange Betting Strategy For WIN-DRAW-LOSS Markets](http://www.rankingsoftware.com/research/OptimalBettingStrategyWinDrawLoss.pdf)
  * [Kelly criterion with more than two outcomes](http://math.stackexchange.com/questions/662104/kelly-criterion-with-more-than-two-outcomes)
  * [凯利模式资金管理](http://ch-hsieh.blogspot.com/2015/01/kelly-criterion-0.html)
  * [Wrangling F1 Data With R](http://www.r-bloggers.com/wrangling-f1-data-with-r-f1datajunkie-book/)
  * [Interactive visualizations with R - a minireview](http://ouzor.github.io/blog/2014/11/21/interactive-visualizations.html)
  * [R + htmlwidgets + DT + sparkline](https://englianhu.wordpress.com/2015/10/04/r-htmlwidgets-dt-sparkline/)
  
  
<img src='figure/JJ 01.jpg' width='48'>

**Powered by - Copyright© Intellectual Property Rights of <img src='figure/Orchard.jpg' width='24'> [Scibrokes®](http://www.scibrokes.com)**



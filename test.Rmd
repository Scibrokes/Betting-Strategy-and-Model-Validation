---
title: "テスト <img src='http://datemasamune.com/history/images/top_img_01.jpg' width='28'>"
author: "伊達正宗 <img src='http://z.abang.com/f/rxwanju/1/3/s/B/0/-/FIG-IPN-1490_02.jpg' width='22'>"
date: "October 25, 2015"
output: 
  html_document: 
    fig_caption: yes
    highlight: haddock
    theme: cerulean
    toc: yes
  word_document: 
    fig_caption: yes
  pdf_document: 
    fig_caption: yes
    toc: yes
---

Testing output of the coding.

```{r}
## Loading the packages and setting adjustment
source(paste0(getwd(),'/function/libs.R'))
```

```{r}
## Read the datasets
## Refer to **Testing efficiency of coding.Rmd** at chunk `get-data-summary-table-2.1`
years <- seq(2011,2015)

## Here I take the majority leagues setting profile which are "league-10-12"
## fMYPriceB = Back with vigorish price; fMYPriceL = Lay with vigorish price
## Here we term as Fair Odds
lProfile <- c(AH=0.10,OU=0.12)

mbase <- readfirmDatasets(years=years) %>% arrfirmDatasets(., lProfile=lProfile)

## In order to analyse the AHOU, here I need to filter out all soccer matches other than AHOU. (For example : Corners, Total League Goals etc.)
## the stakes amount display as $1 = $10,000
#'@ mbase$datasets[!(mbase$datasets$Home %in% mbase$corners)|!(mbase$datasets$Away %in% mbase$corners),]
dat <- mbase$datasets %>% filter((!Home %in% mbase$others)|(!Away %in% mbase$others)) %>% mutate(Stakes=Stakes/10000, Return=Return/10000, PL=PL/10000, Month=month(ymd(Date), label=TRUE))

#'@ pander(head(dat)) # exactly same layout with kable(x)
#'@ kable(head(dat)) ## example of the dataset in the research paper

dat %>% datatable(.,caption="Table 2.1.1 : Firm A Staking Data",extensions=c('ColReorder','ColVis','TableTools'),options=list(dom='TC<"clear">rlfrtip',colVis=list(exclude=c(0),activate='mouseover'),tableTools=list(sSwfPath=copySWF(pdf=TRUE)),scrollX=TRUE,scrollCollapse=TRUE))

rm(years, readfirmDatasets, arrfirmDatasets)
rm(mbase) ## We need to scrap the livescore data based on the raw data mbase without filter, but this is not the point in this research paper.
```

  Please refer to [Natural Language Analysis](http://rpubs.com/englianhu/natural-language-analysis) to see the firm A staking sample dataset.
  
```{r}
fuBets <- data.frame(ddply(dat, ~AHOU+pHKRange+pMYRange+Picked,
                           .drop=TRUE, colwise(.fun=sum, .cols=~Stakes+Return+PL, na.rm=TRUE)),
                     ddply(dat, ~AHOU+pHKRange+pMYRange+Picked,
                           .drop=TRUE, colwise(.fun=mean, .cols=~Stakes+Return+PL, na.rm=TRUE)) %>% .[(ncol(.)-2):ncol(.)],
                     ddply(dat, ~AHOU+pHKRange+pMYRange+Picked,
                           .drop=TRUE, colwise(.fun=sd, .cols=~Stakes+Return+PL, na.rm=TRUE)) %>% .[(ncol(.)-2):ncol(.)],
                     ddply(dat, ~AHOU+pHKRange+pMYRange+Picked,
                           .drop=TRUE, colwise(.fun=length, .cols=~Stakes)) %>% .[(ncol(.)-2):ncol(.)]) %>% tbl_df
names(fuBets) <- suppressWarnings(c('AHOU','pHKRange','pMYRange','Picked','Stakes','Return','PL','S.median','R.median','PL.median','S.mean','R.mean','PL.mean','S.sd','R.sd','PL.sd','Count'))
fuBets %<>% mutate(Stakes=round(Stakes,2), Return=round(Return,2), PL=round(PL,2), S.mean=round(S.mean,2), R.mean=round(R.mean,2), PL.mean=round(PL.mean,2), S.sd=round(S.sd,2), R.sd=round(R.sd,2), PL.sd=round(PL.sd,2), R.percent=sprintf(Return/Stakes,fmt="%1.4f%%"), PL.percent=sprintf(PL/Stakes,fmt="%1.4f%%"))
```

*graph 3.4.1b*

```{r}
funs <- expression(sum,mean,median,sd,length)
fuBets <- llply(funs, function(x)
    ddply(dat, ~AHOU+pHKRange+pMYRange+Picked, .drop=TRUE, colwise(.fun=x, .cols=~Stakes+Return+PL))) %>% join_all(by=c('AHOU','pHKRange','pMYRange','Picked')) %>% .[-c((ncol(.)-1):ncol(.))] %>% tbl_df

names(fuBets) <- suppressWarnings(c('AHOU','pHKRange','pMYRange','Picked','Stakes','Return','PL','S.mean','R.mean','PL.mean','S.median','R.median','PL.median','S.sd','R.sd','PL.sd','Count'))

fuBets %<>% mutate(Stakes=round(Stakes,2), Return=round(Return,2), PL=round(PL,2), S.mean=round(S.mean,2), R.mean=round(R.mean,2), PL.mean=round(PL.mean,2), S.sd=round(S.sd,2), R.sd=round(R.sd,2), PL.sd=round(PL.sd,2), Count=length(Stakes), R.percent=sprintf(Return/Stakes,fmt="%1.4f%%"), PL.percent=sprintf(PL/Stakes,fmt="%1.4f%%"))
```

```{r, results='asis'}
## Set options back to original options
options(op)
```



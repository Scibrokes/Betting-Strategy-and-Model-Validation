---
title: "Report with ShinyApps <img src='figure/sunnylin.jpg' width='24'> : *Linear Regression Analysis on Odds Price of Stakes*"
author: "[®γσ, Eng Lian Hu](https://englianhu.github.io/) <img src='figure/ShirotoNorimichi2.jpg' width='24'> 白戸則道®"
date: "August 28, 2016"
output: html_document
runtime: shiny
resource_files:
- data/livescore.zip
- data/2011.csv
- data/2012.csv
- data/2013.csv
- data/2014.csv
- data/2015.csv
- data/teamID.csv
- function/readfirmData.R
- function/arrDataElem.R
- function/arrfirmData.R
- function/arrTeamID.R
- function/bvp.R
- function/libs.R
- function/makeList.R
- function/partialMatch.R
- function/readSPBO.R
- function/scrapSPBO.R
- function/signature.R
- function/stringdistList.R
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message = FALSE, warning = FALSE, cache = TRUE, include = FALSE}
## Setup Options, Loading Required Libraries and Preparing Environment
## Loading the packages and setting adjustment
suppressMessages(library('utils'))
suppressMessages(source('function/libs.R'))
#'@ suppressMessages(source('https://raw.githubusercontent.com/scibrokes/betting-strategy-and-model-validation/master/function/libs.R'))
```

# Abstract

  This is an academic research by apply R statistics analysis to an agency A of an existing betting consultancy firm A. According to the *Dixon and Pope (2004)*^[Kindly refer to 24th paper in [Reference for industry knowdelege and academic research portion for the paper.] in **7.4 References**], due to business confidential and privacy I am also using agency A and firm A in this paper. **The purpose of the anaysis is measure the staking model of the firm A**. For more sample which using R for Soccer Betting see <http://rpubs.com/englianhu>. Here is the references of [rmarkdown](http://rmarkdown.rstudio.com/authoring_basics.html) and [An Introduction to R Markdown](http://rpubs.com/mansun_kuo/24330). You are welcome to read the *Tony Hirst (2014)*^[Kindly refer to 1st paper in [Reference for technical research on programming and coding portion for the paper.] in **7.4 References**] if you are getting interest to write a data analysis on Sports-book.

# 1. Introduction to the Betting Stategics

  - Section [1.1 Introducing Betting Strategies] - Introduce Betting Strategies
  - Section [1.2 Value Betting] - Odds Price and Overrounds Changared by Bookmakers
  - Section [1.3 Professional Gambler] - Punters' life and How Hedge Fund Works

# 2. Data

  - Section [2.1 Collect and Reprocess the Data] - Data from Firm A
  - Section [2.2 Overrounds / Vigorish] - Odds Price and Overrounds Changared by Bookmakers

```{r read-data-summary-table, message = FALSE, warning = FALSE, echo = FALSE, results = 'asis'}
## Load package again due to unable find the function
suppressMessages(require('dplyr', quietly = TRUE))

## Read the data
## Refer to **Testing efficiency of coding.Rmd** at chunk `get-data-summary-table-2.1`
years <- seq(2011, 2015)

## Here I take the majority leagues setting profile which are "league-10-12"
## fMYPriceB = Back with vigorish price; fMYPriceL = Lay with vigorish price
## Here we term as Fair Odds
lProfile <- c(AH = 0.10, OU = 0.12)

mbase <- readfirmData(years = years) %>% arrfirmData(lProfile = lProfile)

## In order to analyse the AHOU, here I need to filter out all soccer matches other than AHOU. (For example : Corners, Total League Goals etc.)
## the stakes amount display as $1 = $10,000
#'@ mbase$datasets[!(mbase$datasets$Home %in% mbase$corners)|!(mbase$datasets$Away %in% mbase$corners),]
dat <- mbase$datasets %>% filter((!Home %in% mbase$others)|(!Away %in% mbase$others)) %>% mutate(Stakes = Stakes/10000, Return = Return/10000, PL = PL/10000)
```

# 3. Summarise the Staking Model

  - Section [3.1 Summarise Diversified Periodic Stakes] - Summarise the Stakes and Return
  - Section [3.2 Summarise the Staking Handicap] - Summarise the Staking Handicap Breakdown
  - Section [3.3 Summarise the Staking Prices] - Summarise the Staking Price Range Breakdown
  - Section [3.4 Summarise the In-Play Staking Timing] - Summarise the In-Play Staking Breakdown by Time Range
  - Section [3.5 Summarise the In-Play Staking Based on Current Score] - Summarise the In-Play Staking Breakdown by Current Score

# 4. Staking Ⓜodel

  - Section [4.1 Basic Equation] - Analyse the Odds Price and Probabilities
  - Section [4.2 Linear Ⓜodel] - Reversed Engineer to get the EMOdds derived from Stakes
  - Section [4.3 Kelly Ⓜodel] - Test the Kelly Model.
  - Section [4.4 Poisson Ⓜodel] - Soccer Scores, Odds Price and Stakes modelling.
  - Section [4.5 Staking Ⓜodel and Ⓜoney Ⓜanagement] - Simulate the staking model.
  - Section [4.6 Expectation Ⓜaximization and Staking Simulation] - Enhance by weighted function on Staking model and Simulation.

## 4.2 Linear Ⓜodel

  Again, I don't pretend to know the correct Ⓜodel, here I simply apply linear model to retrieve the value of *EMOdds* derived from stakes. The purpose of measure the edge overcame bookmakers' vigorish is *to know the levarage of the staking activities onto 1 unit edge of odds price by firm A to agency A*.

```{r linear-models, echo = FALSE, results = 'asis'}
## Choosing the variables of linear models
## The net probabilities might open diversified handicap, therefore the HCap parameter need to be insert as one of parameter since the return of draw-no-bet, win-half, win-full, loss-half, loss-full (example : 0, 0/0.5, 0.5, 0.5/1, 1) affect the return of investment.
lm0 <- lm(Return ~ Stakes, data = dat)
lm1 <- lm(Return ~ Stakes + HCap, data = dat)
lm2 <- lm(Return ~ Stakes + netProbB, data = dat)
lm3 <- lm(Return ~ Stakes + HCap + netProbB, data = dat)
lm4 <- lm(Return ~ Stakes + ipRange, data = dat)
lm5 <- lm(Return ~ Stakes + ipHCap, data = dat)
lm6 <- lm(Return ~ Stakes + HCap + ipRange, data = dat)
lm7 <- lm(Return ~ Stakes + CurScore + ipHCap, data = dat)
lm8 <- lm(Return ~ Stakes + CurScore + ipRange, data = dat)
lm9 <- lm(Return ~ Stakes + CurScore + ipRange + ipHCap, data = dat)

## Linear Interative Effect Models
lm10 <- lm(Return ~ HCap + netProbB + HCap:netProbB, data = dat)
lm11 <- lm(Return ~ Stakes + ipHCap + ipRange + ipHCap:ipRange, data = dat)
lm12 <- lm(Return ~ Stakes + CurScore + ipRange + ipHCap + CurScore:ipHCap:ipRange, data = dat)

## Linear Mixed Effects Models
## Mixed effect categorised the parameters by group... similar with current score during living betting modelling, the scoring rate (intensity of scores) during 0-0 is different with scoring rates during 1-0 etc.
lm13 <- lm(Return ~ Stakes + (1|HCap), data = dat)
lm14 <- lm(Return ~ HCap + (1|Stakes), data = dat) # the stakes amount placed by firm A must be based on the degree of the edges to punter. Here I try to test the effect. (Although firm A might bet via several agents, here I can only took available sample from population to test the efficiency.)

lms <- list(lm0 = lm0, lm1 = lm1, lm2 = lm2, lm3 = lm3, lm4 = lm4, lm5 = lm5, lm6 = lm6, lm7 = lm7, lm8 = lm8, lm9 = lm9, lm10 = lm10, lm11 = lm11, lm12 = lm12, lm13 = lm13, lm14 = lm14)
```

<s>
```{r lm-summary, echo = FALSE, eval = FALSE, results = 'asis'}
#'@ anova to compare the models
#'@ anova(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14, test = 'F')

## xtable always shows LaTeX output but not table.
#'@ list(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14) %>% llply(., function(x) print(xtable(x), floating = TRUE, type = 'html'))

#'@ list(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14) %>% llply(., stargazer, type = 'html')
stargazer(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14, type = 'html')

#'@ list(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14) %>% llply(., texreg)
```

*table 4.2.1 : Summary of linear models.*

```{r lm-anova, echo = FALSE, eval = FALSE, results = 'asis'}
## xtable always shows LaTeX output but not table.
#'@ list(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14) %>% llply(., function(x) print(xtable(anova(x)), floating = TRUE, type = 'html'))

#'@ list(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14) %>% llply(., function(x) stargazer(anova(x), type = 'html'))

#'@ stargazer(anova(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12 lm13, lm14), type = 'html')

stargazer(anova(lm0, lm1, lm2, lm3, lm4), type = 'html')
#'@ list(lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12) %>% llply(stargazer, anova, type = 'html')
stargazer(anova(lm5), type = 'html')
stargazer(anova(lm6), type = 'html')
stargazer(anova(lm7), type = 'html')
stargazer(anova(lm8), type = 'html')
stargazer(anova(lm9), type = 'html')
stargazer(anova(lm10), type = 'html')
stargazer(anova(lm11), type = 'html')
stargazer(anova(lm12), type = 'html')
stargazer(anova(lm13), type = 'html')
stargazer(anova(lm14), type = 'html')

#'@ list(lm0, lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9, lm10, lm11, lm12, lm13, lm14) %>% llply(., function(x) texreg(anova(x)))
```

*table 4.2.2 : Anova of linear models.*
</s>

```{r shiny-summary, echo = FALSE, results = 'asis'}
## Load package again due to cannot find the function
suppressMessages(require('shiny', quietly = TRUE))

#'@ runApp( ## Cannot use runApp() with list(ui, server) since it will open an independent webpage but unable embed into rmarkdown file. It will endless stuck in knitting progress...
#'@     list(
shinyApp(
      ui = fluidPage(
        titlePanel('Summary of linear models to test the efficiency of staking model of firm A.'), 
        
        ## this is your web page header information
        tags$head(
        ## here you include your inline styles
        tags$style(HTML("
         body {
           background-color: darkgoldenrod;
           color: #B8860B;
         }
        "))
        ),
        
        # Sidebar with a slider input for number of bins
        sidebarLayout(
          sidebarPanel(
            h2('Select variables below for your linear model'),
            selectInput('response', label = h4('What is the column name of your response variable Y?'), choices = names(dat)),
            checkboxGroupInput('explan1', label = h4('What is the column(s) name of your explanatory variable X?'), choices = names(dat)),
            actionButton('analysis', 'Analyze!')),
          
          mainPanel(
            tabsetPanel(
              tabPanel('Your model', verbatimTextOutput('modelSummary')),
              tabPanel('Model 01', verbatimTextOutput('model0')),
              tabPanel('Model 02', verbatimTextOutput('model1')),
              tabPanel('Model 03', verbatimTextOutput('model2')),
              tabPanel('Model 04', verbatimTextOutput('model3')),
              tabPanel('Model 05', verbatimTextOutput('model4')),
              tabPanel('Model 06', verbatimTextOutput('model5')),
              tabPanel('Model 07', verbatimTextOutput('model6')),
              tabPanel('Model 08', verbatimTextOutput('model7')),
              tabPanel('Model 09', verbatimTextOutput('model8')),
              tabPanel('Model 10', verbatimTextOutput('model9')),
              tabPanel('Model 11', verbatimTextOutput('model10')),
              tabPanel('Model 12', verbatimTextOutput('model11')),
              tabPanel('Model 13', verbatimTextOutput('model12')),
              tabPanel('Model 14', verbatimTextOutput('model13')),
              tabPanel('Model 15', verbatimTextOutput('model14')),
              tabPanel('Reference', h4('Reference:'),
                   p('1. ', HTML("<a href='https://www.youtube.com/watch?v=66z_MRwtFJM'>Linear Regression in R (R Tutorial 5.1 to 5.11)</a>")),
                   p('2. ', HTML("<a href='http://www.r-bloggers.com/getting-started-with-mixed-effect-models-in-r/'>Getting Started with Mixed Effect Models in R</a>")),
                   p('3. ', HTML("<a href='...'>A very basic tutorial for performing linear mixed effects analyses</a>")),
                   p('4. ', HTML("<a href='...'>Linear Models with R</a>")),
                   p('5. ', HTML("<a href='...'>Extending the Linear Model with R : Generalized Linear, Mixed Effects and Nonparametric Regression Models</a>")))))
          )
        ),
      
      server = function(input, output) {
        observeEvent(input$analysis, {
          y = ifelse(is.null(input$response)||is.na(input$response)||length(input$response) == 0, 'Return', input$response)
          x = ifelse(is.null(input$explan1)||is.na(input$explan1)||length(input$explan1) == 0, 'Stakes', input$explan1)

          model = lm(as.formula(paste0(y, '~', paste(x, collapse = ' + '))), data = dat)
          output$modelSummary = renderPrint({
            list(Summary = summary(model), Anova = anova(model))
            })
          })
        
        output$model0 <- renderPrint(list(Summary = summary(lm0), Anova = anova(lm0, lm1, lm2, lm3, lm4)))
        output$model1 <- renderPrint(list(Summary = summary(lm1), Anova = anova(lm0, lm1, lm2, lm3, lm4)))
        output$model2 <- renderPrint(list(Summary = summary(lm2), Anova = anova(lm0, lm1, lm2, lm3, lm4)))
        output$model3 <- renderPrint(list(Summary = summary(lm3), Anova = anova(lm0, lm1, lm2, lm3, lm4)))
        output$model4 <- renderPrint(list(Summary = summary(lm4), Anova = anova(lm0, lm1, lm2, lm3, lm4)))
        output$model5 <- renderPrint(list(Summary = summary(lm5), Anova = anova(lm5)))
        output$model6 <- renderPrint(list(Summary = summary(lm6), Anova = anova(lm6)))
        output$model7 <- renderPrint(list(Summary = summary(lm7), Anova = anova(lm7)))
        output$model8 <- renderPrint(list(Summary = summary(lm8), Anova = anova(lm8)))
        output$model9 <- renderPrint(list(Summary = summary(lm9), Anova = anova(lm9)))
        output$model10 <- renderPrint(list(Summary = summary(lm10), Anova = anova(lm10)))
        output$model11 <- renderPrint(list(Summary = summary(lm11), Anova = anova(lm11)))
        output$model12 <- renderPrint(list(Summary = summary(lm12), Anova = anova(lm12)))
        output$model13 <- renderPrint(list(Summary = summary(lm13), Anova = anova(lm13)))
        output$model14 <- renderPrint(list(Summary = summary(lm14), Anova = anova(lm14)))
        }
  #'@    )
  #'@  )
  )
```

*shinyapp 4.2.1 : Summary and anova of linear models.*

```{r shiny-calc01, echo = FALSE, results = 'asis'}
library('shiny')
library('dplyr')

shinyApp(
  ui = fluidPage(
    titlePanel('1 x 2 Combo to AH (by William Chen 2006)'),
    
    ## this is your web page header information
    #'@ tags$head(
    ## here you include your inline styles
    #'@ tags$style(HTML("
    #'@   body {
    #'@     background-color: darkgoldenrod;
    #'@     color: #B8860B;
    #'@   }
    #'@ "))
    #'@ ),
    
    fluidRow(
      column(3, numericInput('num1', label = 'Home Win', value = 2.5)),
      column(4, numericInput('num2', label = 'Draw', value = 3.20)),
      column(5, numericInput('num3', label = 'Away Win', value = 2.5))),
    fluidRow(
      column(3, ''),
      column(4, numericInput('spread', label = 'Spread / Vigorish / Overround', value = 1.12))),
    hr(),
    fluidRow(
      column(3, ''),
      column(4, verbatimTextOutput('txt'))),
    fluidRow(
      column(3, tableOutput('tab1')),
      column(4, ''),
      column(5, tableOutput('tab2'))),
    fluidRow(
      column(3, ''),
      column(4, tableOutput('tab3'))),
    fluidRow(
      column(3, tableOutput('tab4')),
      column(4, ''),
      column(5, tableOutput('tab5')))),
  
  server = function(input, output) {

    output$txt <- renderText({
      fOdds <- c(input$num1, input$num2, input$num3) / input$spread
      c(paste0('Home Win = ', round(fOdds[1], 3)), ';', paste0('Draw = ', round(fOdds[2], 3)), ';', paste0('Away Win = ', round(fOdds[3], 3)))
    })
    
    output$tab1 <- renderTable({
      fOdds <- c(input$num1, input$num2, input$num3) / input$spread
      data_frame(Team = c('Home', 'Away'), Hdp = c('0.5', ''), Price = c(fOdds[1] - 1, ((fOdds[2] * fOdds[3]) / (fOdds[2] + fOdds[3])) - 1))
    })
    
    output$tab2 <- renderTable({
      fOdds <- c(input$num1, input$num2, input$num3) / input$spread
      data_frame(Team = c('Home', 'Away'), Hdp = c('', '0.5'), Price = c(((fOdds[1] * fOdds[2]) / (fOdds[1] + fOdds[2])) - 1, fOdds[3] - 1))
    })
    
    output$tab3 <- renderTable({
      fOdds <- c(input$num1, input$num2, input$num3) / input$spread
      data_frame(Team = c('Home', 'Away'), Hdp = c('0', '0'), Price = c(((fOdds[1] * fOdds[2]) - fOdds[1] - fOdds[2]) / fOdds[2], ((fOdds[2] * fOdds[3]) - fOdds[2] - fOdds[3]) / fOdds[2]))
    })
    
    output$tab4 <- renderTable({
      fOdds <- c(input$num1, input$num2, input$num3) / input$spread
      data_frame(Team = c('Home', 'Away'), Hdp = c('0/0.5', ''), Price = c(((2 * fOdds[1] * fOdds[2]) - fOdds[1] - (2 * fOdds[2])) / (2 * fOdds[2]), ((2 * fOdds[2] * fOdds[3]) - (2 * fOdds[2]) - (2 * fOdds[3])) / ((2 * fOdds[2]) + fOdds[3])))
    })
    
    output$tab5 <- renderTable({
      fOdds <- c(input$num1, input$num2, input$num3) / input$spread
      data_frame(Team = c('Home', 'Away'), Hdp = c('', '0/0.5'), Price = c(((2 * fOdds[1] * fOdds[2]) - (2 * fOdds[1]) - (2 * fOdds[2])) / ((2 * fOdds[2]) + fOdds[1]), ((2 * fOdds[2] * fOdds[3]) - fOdds[3] - (fOdds[2])) / (2 * fOdds[2])))
    })
    },
  options = list(height = 500)
  )
```

*shinyapp 4.2.2 : Comparison of the vigorish between AH and Fixed-Odds. Source from 1x2 to Combo AH version 1.1 by William Chen (2006)*

# 5. Result

  - Section [5.1 Comparison of the Results] - Comparison of the Returns of Staking Models.
  - Section [5.2 Ⓜarket Basket] - Analyse the Hedging or Double up Invest by Firm A.

# 6. Conclusion

  - Section [6.1 Conclusion] - Conclusion of this Research Paper.
  - Section [6.2 Future Works] - Future Research or Enhancement.

# 7. Appendices

  - Section [7.1 Documenting File Creation ] - Information of the Paper.
  - Section [7.2 Versions' Log] - Version Log of the Paper.
  - Section [7.3 Speech and Blooper] - Speech and Blooper during Conducting the Research.
  - Section [7.4 References] - Reference Papers for the Paper.

## 7.1 Documenting File Creation 

  It's useful to record some information about how your file was created.

  - File creation date: 2015-07-22
  - File latest updated date: `r Sys.Date()`
  - `r R.version.string`
  - R version (short form): `r getRversion()`
  - [**rmarkdown** package](https://github.com/rstudio/rmarkdown) version: `r packageVersion('rmarkdown')`
  - [**tufte** package](https://github.com/rstudio/tufte) version: `r packageVersion('tufte')`
  - File version: 1.0.0
  - Author Profile: [®γσ, Eng Lian Hu](https://beta.rstudioconnect.com/englianhu/ryo-eng/)
  - GitHub: [Source Code](https://github.com/Scibrokes/Betting-Strategy-and-Model-Validation)
  - Additional session information
  
```{r info, echo = FALSE, warning = FALSE, results = 'asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))

lubridate::now()
sys1 <- devtools::session_info()$platform %>% unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL
sys1 %>% formattable %>% as.htmlwidget

sys2 <- data.frame(Sys.info()) %>% mutate(Category = rownames(.)) %>% .[2:1]
names(sys2) <- c('Category', 'Sys.info')

sys2 %>% formattable %>% as.htmlwidget

rm(sys1, sys2)
```

**Powered by - Copyright® Intellectual Property Rights of <img src='figure/oda-army.jpg' width='24'> [Scibrokes®](http://www.scibrokes.com)個人の経営企業**
